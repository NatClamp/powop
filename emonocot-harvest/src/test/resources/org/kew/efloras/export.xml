<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
    <changeSet author="jk00kg" id="2012-06-22">
        <comment>Create taxon file</comment>
        <sql>
           SELECT CONCAT('urn:kew.org:efloras:taxon:', n.name_id) AS taxonID,
               (CASE
                   WHEN ifnull(rank, infrarank) = 'family'
                      THEN family
                   WHEN ifnull(rank, infrarank) ='subfamily'
                       THEN concat(family, ' subfam. ', ifnull(infraepi,''))
                   WHEN ifnull(rank, infrarank) = 'genus'
                       THEN genus
                   WHEN ifnull(rank, infrarank) IN('series', 'subgen.', 'sect.')
                       THEN concat(genus, ' ', ifnull(rank, infrarank), ' ', infraepi)
                   WHEN ifnull(rank, infrarank) = 'species'
                       THEN concat(genus, ' ', species)
                   WHEN ifnull(rank, infrarank) IN('subspecies', 'subsp.', 'var.', 'forma')
                       THEN concat(genus, ' ', species, ' ', ifnull(rank, infrarank), ' ', infraepi)
                   ELSE
                       (CASE
                           WHEN ifnull(species,'') &lt;&gt; ''
                               THEN concat(genus, ' ', species, if(length(infraepi)>0, ' agg. ' + infraepi,''))
                           WHEN ifnull(genus,'') &lt;&gt; ''
                               THEN concat(genus, if(length(infraepi)>0, ' infragen. ' + infraepi,''))
                           WHEN ifnull(family,'') &lt;&gt; ''
                               THEN concat(family, if(length(infraepi)>0, ' supragen. ' + infraepi,''))
                       END)
               END) AS name,
           ifnull(family,''), ifnull(genus,''), ifnull(species,'') AS specificEpithet, ifnull(infraepi, ''), ifnull(rank, ifnull(infrarank,'')) AS verbatimTaxonRak,  concat(IF(length(par)>0, concat('(',par,') '),''), ifnull(author,'')) AS scientificNameAuthorship
           INTO OUTFILE '/tmp/taxa.txt'
           FIELDS TERMINATED BY '\t'
           LINES TERMINATED BY '\n'
           FROM name n
           WHERE family = 'Iridaceae';
        </sql>
        <rollback />
    </changeSet>
    <changeSet author="jk00kg" id="2012-06-26_0">
        <comment>Create description table</comment>
        <sql>
            CREATE TEMPORARY TABLE dwc_description(taxonID VARCHAR(50), description BLOB, description_type VARCHAR(20), source_table VARCHAR(20)) AS
            SELECT CONCAT('urn:kew.org:efloras:taxon:', c.name_id) AS taxonID, GROUP_CONCAT(c.countries SEPARATOR ' ') AS description, 'distribution' AS description_type, 'distributions' AS source_table 
            FROM
            
            (SELECT l.name_id, CONCAT(l.country, ' ', GROUP_CONCAT(l.districts SEPARATOR ' ')) AS countries
            FROM
            
            (SELECT n.name_id, ifnull(d.country, '') AS country, CONCAT(ifnull(d.district, ''), ': ', GROUP_CONCAT(ifnull(d.locref, '') SEPARATOR ' ')) AS districts
            FROM name n INNER JOIN distribution d ON n.taxonNo = d.taxonNo
            WHERE n.family = 'Iridaceae'
              AND n.status = 'A'
            GROUP BY n.name_id, d.country, d.district
            ORDER BY n.name_id, d.country, d.district) AS l
            
            GROUP BY l.name_id, l.country
            ORDER BY l.name_id, l.country) AS c
            
            GROUP BY c.name_id;
        </sql>
        <rollback />
    </changeSet>
    <changeSet author="jk00kg" id="2012-06-26_1">
        <comment>Add 'excountry' (presented online as "Range") to description table</comment>
        <sql>
            INSERT INTO dwc_description
            SELECT CONCAT('urn:kew.org:efloras:taxon:', name_id) AS taxonID, CONCAT(' RANGE: ', GROUP_CONCAT(country SEPARATOR '; ')) AS description, 'distribution' AS description_type, 'excountries' AS source_table
            FROM name n INNER JOIN excountry e ON n.taxonNo = e.taxonNo
            WHERE n.family = 'Iridaceae'
              AND n.status = 'A'
            GROUP BY name_id;
        </sql>
        <rollback />
    </changeSet>
    <changeSet author="jk00kg" id="2012-06-26_2">
        <comment>Create description file</comment>
        <sql>
           SELECT taxonID, GROUP_CONCAT(description SEPARATOR ' '), description_type AS type
           INTO OUTFILE '/tmp/distribution-description.txt'
           FIELDS TERMINATED BY '\t'
           LINES TERMINATED BY '\n'
           FROM dwc_description
           GROUP BY taxonID, description_type;
        </sql>
        <rollback />
    </changeSet>
</databaseChangeLog>
