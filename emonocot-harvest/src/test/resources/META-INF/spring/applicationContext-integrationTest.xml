<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:context="http://www.springframework.org/schema/context"
	xmlns:int="http://www.springframework.org/schema/integration"
    xmlns:int-jdbc="http://www.springframework.org/schema/integration/jdbc"
    xmlns:int-mail="http://www.springframework.org/schema/integration/mail"
	xmlns:jms="http://www.springframework.org/schema/integration/jms"
    xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-2.1.xsd
        http://www.springframework.org/schema/integration/jdbc http://www.springframework.org/schema/integration/jdbc/spring-integration-jdbc-2.1.xsd
        http://www.springframework.org/schema/integration/mail http://www.springframework.org/schema/integration/mail/spring-integration-mail-2.1.xsd">
    
	<context:property-placeholder location="classpath*:META-INF/spring/*.properties" />
    
    <int-jdbc:inbound-channel-adapter channel="jdbcCommentChannel" data-source="dataSource" row-mapper="commentRowMapper"
            query="SELECT * FROM Comment c WHERE c.status = 'PENDING'"
            update="UPDATE Comment c SET status = 'SENT' WHERE c.id IN (:id)">
        <int:poller fixed-rate="1000" />
    </int-jdbc:inbound-channel-adapter>
    <bean id="commentRowMapper" class="org.emonocot.persistence.dao.jdbc.ExtensibleBeanPropertyRowMapper">
        <property name="mappedClass" value="org.emonocot.model.Comment" />
        <property name="editors">
            <map>
                <entry key="org.joda.time.DateTime"><bean class="org.emonocot.persistence.dao.jdbc.DateTimePropertyEditor" /></entry>
            </map>
        </property>
    </bean>
    
    <int:channel id="jdbcCommentChannel" />
    
    <int:splitter input-channel="jdbcCommentChannel" output-channel="commentChannel" />
    
    <int:channel id="commentChannel" />
    
    <int:chain id="enrichingChain" input-channel="commentChannel" output-channel="enrichedCommentChannel">
        <int:header-enricher>
            <int:header name="destinations" ref="commentService" method="getDestinationOrganisations" />
        </int:header-enricher>
        <int:splitter>
            <bean class="org.emonocot.integration.HeaderCollectionSplitter">
                <property name="requestKey" value="destinations" />
                <property name="responseKey" value="organisation" />
            </bean>
        </int:splitter>
        <int:header-enricher>
            <int:header name="templateName" value="${comment.email.template}" />
            <int:header name="toAddress" expression="headers.organisation.commentsEmailedTo" />
            <int:header name="subject" value="${comment.email.subject}" />
        </int:header-enricher>
    </int:chain>
    <bean id="commentService" class="org.emonocot.service.impl.CommentServiceImpl" />
    
    <int:channel id="enrichedCommentChannel" />
    
    <int:outbound-channel-adapter channel="enrichedCommentChannel" ref="testTransformedMessageHandler" method="handle" />
    <bean id="testTransformedMessageHandler" class="org.emonocot.integration.MessageHandler" />
    
</beans>
