<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:batch="http://www.springframework.org/schema/batch"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
	                    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
	                    http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd">
	<context:property-placeholder location="classpath*:META-INF/spring/*.properties" />
	<context:annotation-config />

	<batch:job id="IdentificationKeyHarvesting">
		<batch:description>Harvests a single SDD file containing a multi-access key</batch:description>
		<batch:step id="setTemporaryFilename">
			<batch:description>Set the temporary file name</batch:description>
			<batch:tasklet ref="setTemporaryFilenameTasklet" />
			<batch:next on="COMPLETED" to="getIdentificationKey" />
		</batch:step>
		<batch:step id="getIdentificationKey">
			<batch:description>Get the sdd file</batch:description>
			<batch:tasklet ref="getIdentificationKeyTasklet" />
			<batch:next on="NOT MODIFIED" to="cleanupResourcesNotModified" />
			<batch:next on="COMPLETED" to="processTaxonNames" />
		</batch:step>
		<batch:step id="processTaxonNames">
			<batch:description>Process the records</batch:description>
			<batch:tasklet>
				<batch:chunk reader="taxonNameReader" processor="taxonNameProcessor"
					writer="taxonNameWriter" commit-interval="10">
				</batch:chunk>
			</batch:tasklet>
			<batch:next on="COMPLETED" to="cleanupResources" />
			<batch:listeners>
				<batch:listener ref="hibernateSessionClearingChunkListener" />
			</batch:listeners>
		</batch:step>
		<batch:step id="cleanupResourcesNotModified">
			<batch:description>Cleanup the resources</batch:description>
			<batch:tasklet ref="resourceDeletingTasklet" />
			<batch:end on="COMPLETE" exit-code="NOT MODIFIED" />
		</batch:step>
		<batch:step id="cleanupResources">
			<batch:description>Cleanup the resources</batch:description>
			<batch:tasklet ref="resourceDeletingTasklet" />
			<batch:end on="COMPLETED" />
		</batch:step>
	</batch:job>

	<bean id="setTemporaryFilenameTasklet" class="org.emonocot.harvest.common.SetTemporaryFilenameTasklet">
		<property name="harvesterSpoolDirectory" value="${harvester.spool.directory}" />
	</bean>

	<bean id="resourceDeletingTasklet"
		class="org.emonocot.harvest.common.MultiResourceDeletingTasklet"
		scope="step">
		<property name="resources">
			<list>
				<bean class="org.springframework.core.io.FileSystemResource"
					scope="step">
					<constructor-arg value="#{jobExecutionContext['input.file.name']}" />
				</bean>
				<bean class="org.springframework.core.io.FileSystemResource"
					scope="step">
					<constructor-arg value="#{jobExecutionContext['transform.file.name']}" />
				</bean>
				<bean class="org.springframework.core.io.FileSystemResource"
					scope="step">
					<constructor-arg value="#{jobExecutionContext['output.file.name']}" />
				</bean>
			</list>
		</property>
	</bean>

	<bean id="getIdentificationKeyTasklet"
		class="org.springframework.batch.core.step.tasklet.MethodInvokingTaskletAdapter"
		scope="step">
		<property name="targetObject" ref="getResourceClient" />
		<property name="targetMethod" value="getResource" />
		<property name="arguments">
			<list>
				<value>#{jobParameters['authority.name']}</value>
				<value>#{jobParameters['authority.uri']}</value>
				<value>#{jobParameters['authority.last.harvested']}</value>
				<value>#{jobExecutionContext['input.file.name']}</value>
			</list>
		</property>
	</bean>

	<bean id="taxonNameReader" class="org.emonocot.job.io.StaxEventItemReader"
		scope="step">
		<property name="fragmentRootElementName" value="TaxonName" />
		<property name="resource">
			<bean class="org.springframework.core.io.FileSystemResource"
				scope="step">
				<constructor-arg value="#{jobExecutionContext['input.file.name']}" />
			</bean>
		</property>
		<property name="unmarshaller" ref="keyUnmarshaller" />
		<property name="encoding" value="UTF-8" />
	</bean>

	<bean id="taxonNameProcessor" class="org.emonocot.job.key.TaxonNameProcessor"
		scope="step">
		<property name="nameParser" ref="nameParser" />
		<property name="taxonMatcher" ref="taxonMatcher" />
		<property name="sourceService" ref="sourceServiceImpl" />
		<property name="sourceName" value="#{jobParameters['authority.name']}" />
	</bean>




	<bean id="taxonNameWriter" class="org.springframework.batch.item.xml.StaxEventItemWriter">
		<property name="encoding" value="UTF-8" />
		<property name="marshaller" ref="keyUnmarshaller" />
		<property name="resource">
			<bean class="org.springframework.core.io.FileSystemResource"
				scope="step">
				<constructor-arg value="#{jobExecutionContext['transform.file.name']}" />
			</bean>
		</property>
		<property name="rootTagName" value="TaxonNames"/>
		<property name="rootElementAttributes">
		  <map>
		    <entry>
		      <key>
		        <value>xmlns</value>
		      </key>
		      <value>http://rs.tdwg.org/UBIF/2006/</value>
		    </entry>
		  </map>
		</property>
	</bean>

	<bean id="hibernateSessionClearingChunkListener"
		class="org.emonocot.harvest.common.HibernateSessionClearingChunkListener" />

	<bean id="keyUnmarshaller" class="org.emonocot.model.marshall.xml.XStreamMarshaller">
		<property name="autodetectAnnotations" value="true" />
		<property name="streamDriver" ref="streamDriver" />
		<property name="converters">
			<list>
				<bean class="org.emonocot.model.marshall.xml.UriConverter" />
			</list>
		</property>
		<property name="aliases">
			<map>
				<entry>
					<key>
						<value>TaxonName</value>
					</key>
					<value>org.tdwg.ubif.TaxonName</value>
				</entry>
			</map>
		</property>
	</bean>

	<bean id="streamDriver" class="org.emonocot.model.marshall.xml.StaxDriver">
		<constructor-arg ref="qNameMap" />
		<property name="repairingNamespace" value="false" />
		<property name="xmlInputFactory">
			<bean class="com.bea.xml.stream.MXParserFactory" />
		</property>
	</bean>

	<bean id="qNameMap" class="org.tdwg.ubif.marshall.xml.QNameMapFactory" />

	<bean id="getResourceClient" class="org.emonocot.ws.GetResourceClient">
		<property name="proxyHost" value="${http.proxyHost}" />
		<property name="proxyPort" value="${http.proxyPort}" />
	</bean>
</beans>
