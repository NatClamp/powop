<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:batch="http://www.springframework.org/schema/batch"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
	                    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
	                    http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd">
	                    
    <context:property-placeholder ignore-unresolvable="true" location="classpath*:META-INF/spring/*.properties"/>
	
    <context:annotation-config />
	
	<batch:job id="Grassbase">
		<batch:description>Create a darwin core archive from a delta TONAT file and associated resources</batch:description>
		<batch:step id="readSpeciesFile">
			<batch:tasklet>
			    <batch:chunk reader="speciesReader" writer="mapBackedSpeciesMatcher" commit-interval="10"/>    
		    </batch:tasklet>
		    <batch:next on="COMPLETED" to="createSpeciesFile"/>
		</batch:step>
		<batch:step id="createSpeciesFile">
			<batch:tasklet>
			    <batch:chunk reader="speciesItemItemReader" processor="speciesNaturalLanguageProcessor" writer="speciesDescriptionFileWriter" commit-interval="10"/>    
		    </batch:tasklet>
		    <batch:next on="COMPLETED" to="readGeneraFile"/>
		</batch:step>
		<batch:step id="readGeneraFile">
			<batch:tasklet>
			    <batch:chunk reader="generaReader" writer="mapBackedGeneraMatcher" commit-interval="10"/>    
		    </batch:tasklet>
		    <batch:next on="COMPLETED" to="createGeneraFile"/>
		</batch:step>
		<batch:step id="createGeneraFile">
			<batch:tasklet>
			    <batch:chunk reader="generaItemItemReader" processor="generaNaturalLanguageProcessor" writer="generaDescriptionFileWriter" commit-interval="10"/>    
		    </batch:tasklet>
		    <batch:next on="COMPLETED" to="createMetadataFile"/>
		</batch:step>
		<batch:step id="createMetadataFile">
			<batch:description>Create the Metadata file</batch:description>
			<batch:tasklet ref="writeMetadataTasklet"/>
			<batch:next on="COMPLETED" to="copySpeciesTaxonFile"/>
	    </batch:step>
	    <batch:step id="copySpeciesTaxonFile">
	        <batch:description>Copy the species file to the working directory so that it can be packaged</batch:description>
	        <batch:tasklet ref="copySpeciesTaxonFileTasklet"/>
	        <batch:next on="COMPLETED" to="copyGeneraTaxonFile"/>
	    </batch:step>
	    <batch:step id="copyGeneraTaxonFile">
	        <batch:description>Copy the genera file to the working directory so that it can be packaged</batch:description>
	        <batch:tasklet ref="copyGeneraTaxonFileTasklet"/>
	        <batch:next on="COMPLETED" to="copySpeciesDescriptionFile"/>
	    </batch:step>
	    <batch:step id="copySpeciesDescriptionFile">
	        <batch:description>Copy the species description file to the working directory so that it can be packaged</batch:description>
	        <batch:tasklet ref="copySpeciesDescriptionFileTasklet"/>
	        <batch:next on="COMPLETED" to="copyGeneraDescriptionFile"/>
	    </batch:step>
	    <batch:step id="copyGeneraDescriptionFile">
	        <batch:description>Copy the genera description file to the working directory so that it can be packaged</batch:description>
	        <batch:tasklet ref="copyGeneraDescriptionFileTasklet"/>
	        <batch:next on="COMPLETED" to="packageArchive"/>
	    </batch:step>
	    <batch:step id="packageArchive">
			<batch:description>Package the archive up</batch:description>
			<batch:tasklet ref="packageArchiveTasklet"/>
			<batch:next on="COMPLETED" to="cleanupResources"/>
	    </batch:step>
	    <batch:step id="cleanupResources">
			<batch:description>Cleanup the resources</batch:description>
			<batch:tasklet ref="workingDirectoryResourceDeletingTasklet" />
			<batch:end on="COMPLETED"/>
		</batch:step>
	</batch:job>

	<bean id="copySpeciesTaxonFileTasklet" class="org.emonocot.harvest.common.CopyFileTasklet"
		scope="step">
		<property name="from">
			<bean class="org.springframework.core.io.FileSystemResource"
				scope="step">
				<constructor-arg value="#{jobParameters['species.taxon.file']}" />
			</bean>
		</property>
		<property name="to">
			<bean class="org.springframework.core.io.FileSystemResource"
				scope="step">
				<constructor-arg type="java.io.File">
					<bean class="java.io.File" scope="step">
						<constructor-arg type="java.io.File"
							value="${harvester.output.directory}/#{jobParameters['archive.file']}" />
						<constructor-arg type="java.lang.String" value="taxon.txt" />
					</bean>
				</constructor-arg>
			</bean>
		</property>
	</bean>
	
	<bean id="copyGeneraTaxonFileTasklet" class="org.emonocot.harvest.common.CopyFileTasklet" scope="step">
		<property name="from">
			<bean class="org.springframework.core.io.FileSystemResource" scope="step">
				<constructor-arg value="#{jobParameters['genera.taxon.file']}" />
			</bean>
		</property>
		<property name="to">
			<bean class="org.springframework.core.io.FileSystemResource" scope="step">
				<constructor-arg type="java.io.File">
					<bean class="java.io.File" scope="step">
						<constructor-arg type="java.io.File" value="${harvester.output.directory}/#{jobParameters['archive.file']}" />
						<constructor-arg type="java.lang.String" value="taxon.txt" />
					</bean>
				</constructor-arg>
			</bean>
		</property>
		<property name="append" value="true"/>
	</bean>
	
    
    <bean id="copySpeciesDescriptionFileTasklet" class="org.emonocot.harvest.common.CopyFileTasklet" scope="step">
	<property name="from" ref="speciesDescriptionFile" />
	<property name="to">
		<bean class="org.springframework.core.io.FileSystemResource" scope="step">
			<constructor-arg type="java.io.File">
				<bean class="java.io.File" scope="step">
					<constructor-arg type="java.io.File" value="${harvester.output.directory}/#{jobParameters['archive.file']}" />
					<constructor-arg type="java.lang.String" value="description.txt" />
				</bean>
			</constructor-arg>
		</bean>
	</property>
  </bean>
  
  <bean id="copyGeneraDescriptionFileTasklet" class="org.emonocot.harvest.common.CopyFileTasklet" scope="step">
	<property name="from" ref="generaDescriptionFile" />
	<property name="to">
		<bean class="org.springframework.core.io.FileSystemResource" scope="step">
			<constructor-arg type="java.io.File">
				<bean class="java.io.File" scope="step">
					<constructor-arg type="java.io.File" value="${harvester.output.directory}/#{jobParameters['archive.file']}" />
					<constructor-arg type="java.lang.String" value="description.txt" />
				</bean>
			</constructor-arg>
		</bean>
	</property>
	<property name="append" value="true"/>
  </bean>
    
    <bean id="descriptionFile" class="org.springframework.core.io.FileSystemResource" scope="step">
		<constructor-arg type="java.io.File">
			<bean class="java.io.File" scope="step">
				<constructor-arg type="java.io.File" value="${harvester.output.directory}/#{jobParameters['archive.file']}" />
				<constructor-arg type="java.lang.String" value="description.txt" />
			</bean>
		</constructor-arg>
    </bean>
    
    <bean id="speciesDescriptionFile" class="org.springframework.core.io.FileSystemResource" scope="step">
		<constructor-arg type="java.io.File">
			<bean class="java.io.File" scope="step">
				<constructor-arg type="java.io.File" value="${harvester.output.directory}/#{jobParameters['archive.file']}"/>
				<constructor-arg type="java.lang.String" value="species.txt"/>
			</bean>
		</constructor-arg>
	</bean>
	
	<bean id="generaDescriptionFile" class="org.springframework.core.io.FileSystemResource" scope="step">
		<constructor-arg type="java.io.File">
			<bean class="java.io.File" scope="step">
				<constructor-arg type="java.io.File" value="${harvester.output.directory}/#{jobParameters['archive.file']}"/>
				<constructor-arg type="java.lang.String" value="genera.txt"/>
			</bean>
		</constructor-arg>
	</bean>
	
	<bean id="packageArchiveTasklet" class="org.emonocot.job.dwc.write.ArchivePackager" scope="step">
		<property name="archiveFile" value="#{jobParameters['archive.file']}"/>
		<property name="outputDirectory" value="${harvester.output.directory}"/>
		<property name="descriptionFields" value="#{jobParameters['description.file.field.names']}"/>
	</bean>
	
	<bean id="writeMetadataTasklet" class="org.emonocot.job.dwc.write.ArchiveMetadataWriter" scope="step">
		<property name="archiveFile" value="#{jobParameters['archive.file']}"/>		
		<property name="taxonFields" value="#{jobParameters['taxon.file.field.names']}"/>
		<property name="taxonDefaultValues" value="#{jobParameters['taxon.default.values']}"/>
		<property name="descriptionFields" value="#{jobParameters['description.file.field.names']}"/>
	    <property name="descriptionDefaultValues" value="#{jobParameters['description.default.values']}"/>		
		<property name="delimiter" value="#{jobParameters['fields.terminated.by']}"/>
		<property name="quoteCharacter" value="#{jobParameters['fields.enclosed.by']}"/>
		<property name="outputDirectory" value="${harvester.output.directory}"/>
		<property name="citationString" value="#{jobParameters['citation.string']}"/>
		<property name="creatorEmail" value="#{jobParameters['creator.email']}"/>
		<property name="creatorName" value="#{jobParameters['creator.name']}"/>
		<property name="description" value="#{jobParameters['meta.description']}"/>
		<property name="homepageUrl" value="#{jobParameters['homepage.url']}"/>
		<property name="identifier" value="#{jobParameters['identifier']}"/>
		<property name="logoUrl" value="#{jobParameters['logo.url']}"/>
		<property name="publisherEmail" value="#{jobParameters['publisher.email']}"/>
		<property name="publisherName" value="#{jobParameters['publisher.name']}"/>
		<property name="rights" value="#{jobParameters['rights']}"/>
		<property name="subject" value="#{jobParameters['subject']}"/>
		<property name="title" value="#{jobParameters['title']}"/>
	</bean>
	
	<bean id="speciesReader" class="org.springframework.batch.item.file.FlatFileItemReader"
		scope="step">
		<property name="encoding" value="UTF-8" />
		<property name="linesToSkip" value="#{jobParameters['taxon.file.skip.lines']}" />
		<property name="bufferedReaderFactory" ref="bufferedReaderFactory" />
		<property name="resource">
			<bean class="org.springframework.core.io.FileSystemResource" scope="step">
				<constructor-arg value="#{jobParameters['species.taxon.file']}" />
			</bean>
		</property>
		<property name="lineMapper" ref="taxonLineMapper" />
	</bean>
	
	<bean id="generaReader" class="org.springframework.batch.item.file.FlatFileItemReader"
		scope="step">
		<property name="encoding" value="UTF-8" />
		<property name="linesToSkip" value="#{jobParameters['taxon.file.skip.lines']}" />
		<property name="bufferedReaderFactory" ref="bufferedReaderFactory" />
		<property name="resource">
			<bean class="org.springframework.core.io.FileSystemResource" scope="step">
				<constructor-arg value="#{jobParameters['genera.taxon.file']}" />
			</bean>
		</property>
		<property name="lineMapper" ref="taxonLineMapper" />
	</bean>
	
    <bean id="taxonLineMapper" class="org.springframework.batch.item.file.mapping.DefaultLineMapper" scope="step">
		<property name="lineTokenizer" ref="taxonLineTokenizer" />
		<property name="fieldSetMapper" ref="taxonFieldSetMapper" />
	</bean>

	<bean id="taxonLineTokenizer" class="org.springframework.batch.item.file.transform.DelimitedLineTokenizer" scope="step">
		<property name="names" value="#{jobParameters['taxon.file.field.names']}" />
		<property name="delimiter" value="#{jobParameters['fields.terminated.by']}" />
		<property name="quoteCharacter"	value="#{jobParameters['fields.enclosed.by']}" />
		<property name="strict" value="false" />
	</bean>

	<bean id="taxonFieldSetMapper" class="org.emonocot.job.dwc.taxon.FieldSetMapper" scope="step">
		<property name="fieldNames"	value="#{jobParameters['taxon.file.field.names']}" />
	</bean>
	
	
	<bean id="speciesContextHolder" class="org.emonocot.job.delta.DeltaContextHolderImpl" scope="step" init-method="init">
	  <property name="specsFile">
	    <bean class="org.springframework.core.io.FileSystemResource" scope="step">
		    <constructor-arg value="#{jobParameters['species.specs.file']}" />
		</bean>
	  </property>
	</bean>
	
	<bean id="generaContextHolder" class="org.emonocot.job.delta.DeltaContextHolderImpl" scope="step" init-method="init">
	  <property name="specsFile">
	    <bean class="org.springframework.core.io.FileSystemResource" scope="step">
		    <constructor-arg value="#{jobParameters['genera.specs.file']}" />
		</bean>
	  </property>
	</bean>
			
	<bean id="speciesItemItemReader" class="org.emonocot.job.delta.DeltaItemItemReader" scope="step">
	  <property name="itemsFile">
	    <bean class="org.springframework.core.io.FileSystemResource" scope="step">
		    <constructor-arg value="#{jobParameters['species.items.file']}" />
		</bean>
	  </property>	  
	  <property name="deltaContextHolder" ref="speciesContextHolder"/>	  
	</bean>
	
	<bean id="generaItemItemReader" class="org.emonocot.job.delta.DeltaItemItemReader" scope="step">
	  <property name="itemsFile">
	    <bean class="org.springframework.core.io.FileSystemResource" scope="step">
		    <constructor-arg value="#{jobParameters['genera.items.file']}" />
		</bean>
	  </property>	  
	  <property name="deltaContextHolder" ref="generaContextHolder"/>	  
	</bean>
	
	<bean id="speciesNaturalLanguageProcessor" class="org.emonocot.job.delta.DeltaNaturalLanguageProcessor" scope="step">
	  <property name="deltaContextHolder" ref="speciesContextHolder"/>
	  <property name="taxonMatcher" ref="mapBackedSpeciesMatcher"/>
	  <property name="characterForLink" value="#{jobParameters['character.for.link']}"/>
	  <property name="linkPrefix" value="#{jobParameters['link.prefix']}"/>
	  <property name="linkSuffix" value="#{jobParameters['link.suffix']}"/>
	  <property name="filter" ref="speciesNaturalLanguageDatasetFilter"/>
	</bean>
	
	<bean id="speciesNaturalLanguageDatasetFilter" class="au.org.ala.delta.translation.naturallanguage.NaturalLanguageDataSetFilter" scope="step">
	  <constructor-arg value="#{speciesContextHolder.deltaContext}"/>
	</bean>
	
	<bean id="generaNaturalLanguageProcessor" class="org.emonocot.job.delta.DeltaNaturalLanguageProcessor" scope="step">
	  <property name="deltaContextHolder" ref="generaContextHolder"/>
	  <property name="taxonMatcher" ref="mapBackedGeneraMatcher"/>
	  <property name="filter" ref="generaNaturalLanguageDatasetFilter"/>
	</bean>
	
	<bean id="generaNaturalLanguageDatasetFilter" class="org.emonocot.job.grassbase.StripImplictCharsDatasetFilter" scope="step">
	  <constructor-arg value="#{generaContextHolder.deltaContext}"/>
	  <property name="charStatesToStrip">
	    <map>
	      <entry key="9" value="1"/>
	      <entry key="14" value="1"/>
	      <entry key="35" value="1"/>
	      <entry key="70" value="2"/>
	      <entry key="112" value="1"/>
	      <entry key="137" value="1"/>
	      <entry key="154" value="1"/>
	      <entry key="160" value="1"/>
	      <entry key="161" value="3"/>
	      <entry key="169" value="2"/>
	      <entry key="170" value="2"/>
	      <entry key="174" value="1"/>
	      <entry key="175" value="1"/>
	      <entry key="179" value="1"/>
	      <entry key="189" value="1"/>
	      <entry key="207" value="1"/>
	      <entry key="211" value="1"/>
	      <entry key="212" value="2"/>
	      <entry key="213" value="1"/>
	      <entry key="228" value="1"/>
	      <entry key="231" value="1"/>
	      <entry key="234" value="1"/>
	      <entry key="236" value="1"/>
	      <entry key="237" value="1"/>
	      <entry key="242" value="1"/>
	      <entry key="249" value="2"/>
	      <entry key="257" value="1"/>
	      <entry key="278" value="1"/>
	      <entry key="287" value="1"/>
	      <entry key="296" value="1"/>
	      <entry key="317" value="1"/>
	      <entry key="318" value="1"/>
	      <entry key="319" value="4"/>
	      <entry key="320" value="1"/>
	      <entry key="326" value="1"/>
	      <entry key="331" value="1"/>
	      <entry key="332" value="1"/>
	      <entry key="334" value="1"/>
	      <entry key="335" value="1"/>
	      <entry key="336" value="1"/>
	      <entry key="337" value="1"/>
	      <entry key="339" value="1"/>
	      <entry key="340" value="2"/>
	      <entry key="341" value="1"/>
	      <entry key="350" value="1"/>
	      <entry key="359" value="2"/>
	      <entry key="365" value="1"/>
	      <entry key="368" value="1"/>
	      <entry key="369" value="1"/>
	      <entry key="374" value="1"/>
	      <entry key="381" value="1"/>
	      <entry key="402" value="1"/>
	      <entry key="411" value="1"/>
	      <entry key="425" value="4"/>
	      <entry key="427" value="1"/>
	      <entry key="438" value="1"/>
	      <entry key="447" value="1"/>
	      <entry key="451" value="1"/>
	      <entry key="454" value="1"/>
	      <entry key="472" value="1"/>
	      <entry key="481" value="1"/>
	      <entry key="524" value="1"/>
	      <entry key="529" value="1"/>
	      <entry key="535" value="1"/>
	      <entry key="538" value="1"/>
	      <entry key="543" value="1"/>
	      <entry key="545" value="1"/>
	      <entry key="550" value="1"/>
	      <entry key="556" value="1"/>
	      <entry key="560" value="1"/>
	      <entry key="567" value="1"/>
	      <entry key="570" value="1"/>
	      <entry key="573" value="1"/>
	      <entry key="579" value="2"/>
	      <entry key="584" value="5"/>
	      <entry key="587" value="1"/>
	      <entry key="588" value="1"/>
	      <entry key="594" value="2"/>
	      <entry key="596" value="2"/>
	      <entry key="600" value="1"/>
	      <entry key="616" value="1"/>
	      <entry key="623" value="3"/>
	      <entry key="624" value="1"/>
	      <entry key="631" value="1"/>
	      <entry key="633" value="1"/>
	      <entry key="635" value="1"/>
	      <entry key="637" value="1"/>
	      <entry key="640" value="1"/>
	      <entry key="646" value="1"/>
	      <entry key="649" value="1"/>
	      <entry key="657" value="1"/>
	      <entry key="659" value="1"/>
	      <entry key="666" value="1"/>
	      <entry key="674" value="1"/>
	      <entry key="680" value="1"/>
	      <entry key="682" value="1"/>
	      <entry key="686" value="1"/>
	      <entry key="688" value="1"/>
	      <entry key="690" value="1"/>
	      <entry key="691" value="1"/>
	      <entry key="697" value="1"/>
	      <entry key="700" value="1"/>
	      <entry key="702" value="1"/>
	      <entry key="730" value="1"/>
	      <entry key="735" value="1"/>
	      <entry key="753" value="1"/>
	      <entry key="758" value="1"/>
	      <entry key="761" value="1"/>
	      <entry key="786" value="1"/>
	      <entry key="801" value="1"/>
	      <entry key="804" value="1"/>
	      <entry key="809" value="1"/>
	      <entry key="810" value="1"/>
	      <entry key="826" value="1"/>
	      <entry key="827" value="1"/>
	      <entry key="830" value="1"/>
	      <entry key="838" value="1"/>
	      <entry key="843" value="1"/>
	      <entry key="845" value="1"/>
	      <entry key="846" value="1"/>
	      <entry key="847" value="1"/>
	      <entry key="850" value="1"/>
	      <entry key="852" value="1"/>
	      <entry key="853" value="1"/>
	      <entry key="855" value="1"/>
	      <entry key="859" value="1"/>
	      <entry key="866" value="1"/>
	      <entry key="867" value="1"/>
	      <entry key="870" value="1"/>
	      <entry key="872" value="1"/>
	      <entry key="873" value="1"/>
	      <entry key="875" value="1"/>
	      <entry key="880" value="1"/>
	      <entry key="889" value="1"/>
	      <entry key="897" value="1"/>
	      <entry key="899" value="1"/>
	      <entry key="911" value="1"/>
	      <entry key="913" value="1"/>
	      <entry key="917" value="1"/>
	      <entry key="921" value="2"/>
	      <entry key="924" value="4"/>
	      <entry key="926" value="1"/>
	      <entry key="928" value="1"/>
	      <entry key="929" value="1"/>
	      <entry key="931" value="1"/>
	      <entry key="932" value="1"/>
	      <entry key="933" value="1"/>
	      <entry key="940" value="1"/>
	      <entry key="948" value="1"/>
	      <entry key="957" value="1"/>
	      <entry key="967" value="1"/>
	      <entry key="977" value="1"/>
	      <entry key="980" value="1"/>
	      <entry key="983" value="1"/>
	      <entry key="986" value="1"/>
	      <entry key="991" value="1"/>
	      <entry key="1012" value="1"/>
	      <entry key="1016" value="1"/>
	      <entry key="1042" value="1"/>
	      <entry key="1065" value="1"/>
	    </map>
	  </property>
	</bean>
	
	<bean id="mapBackedSpeciesMatcher" class="org.emonocot.job.delta.MapBackedTaxonMatcher"/>
	
	<bean id="mapBackedGeneraMatcher" class="org.emonocot.job.delta.MapBackedTaxonMatcher"/>
	
	<bean id="speciesDescriptionFileWriter" class="org.springframework.batch.item.file.FlatFileItemWriter" scope="step">
	  <property name="resource" ref="speciesDescriptionFile"/>
	  <property name="lineAggregator" ref="lineAggregator"/>
	</bean>
	
	<bean id="generaDescriptionFileWriter" class="org.springframework.batch.item.file.FlatFileItemWriter" scope="step">
	  <property name="resource" ref="generaDescriptionFile"/>
	  <property name="lineAggregator" ref="lineAggregator"/>
	</bean>
	
	<bean name="lineAggregator" class="org.springframework.batch.item.file.transform.DelimitedLineAggregator" scope="step">
	 <property name="delimiter" value="#{jobParameters['fields.terminated.by']}"/>
	 <property name="fieldExtractor">
	   <bean class="org.emonocot.job.dwc.write.DwcFieldExtractor" scope="step">
	     <property name="names" value="#{jobParameters['description.file.field.names']}"/>
	     <property name="quoteCharacter" value="#{jobParameters['fields.enclosed.by']}"/>
	     <property name="extension" value="http://rs.gbif.org/terms/1.0/Description"/>
	     <property name="conversionService" ref="conversionService"/>
	   </bean>
	 </property>
	</bean>
    
    
    <bean id="workingDirectoryResourceDeletingTasklet"
		class="org.emonocot.harvest.common.MultiResourceDeletingTasklet"
		scope="step">
		<property name="resources">
			<list>
				<bean class="org.springframework.core.io.FileSystemResource" scope="step">
				    <constructor-arg value="${harvester.output.directory}/#{jobParameters['archive.file']}" />
				</bean>				
			</list>
		</property>
	</bean>
</beans>
