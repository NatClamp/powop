<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
    <changeSet author="ben" id="2011-05-09-1">
        <createTable tableName="Plant_Name">
            <column name="Plant_name_id" type="integer">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="Full_epithet" type="varchar(255)"/>
            <column name="Institute_id" type="varchar(255)"/>
            <column name="Accepted_plant_name_id" type="integer"/>
        </createTable>
    </changeSet>
    <changeSet author="ben" id="2011-05-09-2">
        <createTable tableName="Plant_Locality">
            <column name="Plant_locality_id" type="integer">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="Area_code_L3" type="varchar(2)"/>
            <column name="Region_code_L2" type="integer"/>
            <column name="Plant_name_id" type="integer"/>
        </createTable>
    </changeSet>
    <changeSet author="ben" id="2011-05-09-3">
        <addForeignKeyConstraint constraintName="FK44FD0CF7BBAC6574"
            baseTableName="Plant_Locality" baseColumnNames="Plant_name_id" referencedTableName="Plant_Name"
            referencedColumnNames="Plant_name_id"/>
    </changeSet>
    <changeSet author="ben" id="2011-05-09-4">
        <createIndex tableName="Plant_Locality" indexName="Plant_Locality_Plant_name_id_IDX">
            <column name="Plant_name_id"/>
        </createIndex>
    </changeSet>
    <changeSet author="ben" id="2011-05-09-5">
        <createIndex tableName="Plant_Name" indexName="Plant_Name_Accepted_plant_name_id_IDX">
            <column name="Accepted_plant_name_id"/>
        </createIndex>
    </changeSet>
    <changeSet author="ben" id="2011-05-09-6">
        <addForeignKeyConstraint constraintName="FKC663741FC1A8E6DC"
            baseTableName="Plant_Name" baseColumnNames="Accepted_plant_name_id" referencedTableName="Plant_Name"
            referencedColumnNames="Plant_name_id"/>
    </changeSet>
    <changeSet author="jk00kg" id="2011-05-25">
        <createTable tableName="Plant_Name_Deleted">
            <column name="Plant_name_id" type="integer">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="Full_epithet" type="varchar(255)"/>
            <column name="Institute_id" type="varchar(255)"/>
            <column name="Accepted_plant_name_id" type="integer"/>
            <column name="Modified_date" type="datetime"/>
            <column name="Deleted_date" type="datetime"/>
        </createTable>
    </changeSet>
    <changeSet author="jk00kg" id="2011-05-19">
        <addColumn tableName="Plant_Name">
            <column name="Modified_date" type="datetime"/>
        </addColumn>
    </changeSet>
    <changeSet author="jk00kg" id="2011-05-27">
        <addColumn tableName="Plant_Name">
            <column name="Date_of_entry" type="datetime"/>
        </addColumn>
        <addColumn tableName="Plant_Name_Deleted">
            <column name="Date_of_entry" type="datetime"/>
        </addColumn>
    </changeSet>
    <!-- This view should include additional columns in changesets above & Deleted_date -->
    <changeSet author="jk00kg" id="2011-05-27_1">
        <createView viewName="vwMonocot_Name">
   /* View created to pull Monocot data from for the eMonocot project */
   /* Also see 'eMonocot' User                                        */
       SELECT  Plant_name_id,
               Date_of_entry,
               Full_epithet,<!--
               Family,
               Genus,
               Genus_hybrid_marker,
               Species,
               Species_hybrid_marker,
               Infraspecific_rank,
               Infraspecific_epithet, -->
               Accepted_plant_name_id,
               Institute_id,
               Modified_date,
               NULL AS Deleted_date
       FROM  Plant_Name
UNION ALL
       SELECT  Plant_name_id,
               Date_of_entry,
               Full_epithet,<!--
               Family,
               Genus_hybrid_marker,
               Genus,
               Species_hybrid_marker,
               Species,
               Infraspecific_rank,
               Infraspecific_epithet,-->
               Accepted_plant_name_id,
               Institute_id,
               Modified_date,
               Deleted_date
       FROM  Plant_Name_Deleted
        </createView>
    </changeSet>
    <changeSet author="jk00kg" id="2011-05-31">
        <addColumn tableName="Plant_Name">
            <column name="Family" type="varchar(30)"/>
            <column name="Genus_hybrid_marker" type="varchar(1)"/>
            <column name="Genus" type="varchar(30)"/>
            <column name="Species_hybrid_marker" type="varchar(1)"/>
            <column name="Species" type="varchar(50)"/>
            <column name="Infraspecific_rank" type="varchar(15)"/>
            <column name="Infraspecific_epithet" type="varchar(50)"/>
        </addColumn>
        <addColumn tableName="Plant_Name_Deleted">
            <column name="Family" type="varchar(30)"/>
            <column name="Genus_hybrid_marker" type="varchar(1)"/>
            <column name="Genus" type="varchar(30)"/>
            <column name="Species_hybrid_marker" type="varchar(1)"/>
            <column name="Species" type="varchar(50)"/>
            <column name="Infraspecific_rank" type="varchar(15)"/>
            <column name="Infraspecific_epithet" type="varchar(50)"/>
        </addColumn>
    </changeSet>
    <changeSet author="jk00kg" id="2011-05-31_1">
        <!-- replaceIfExists attribute needs to be removed if using Sybase -->
        <createView viewName="vwMonocot_Name" replaceIfExists="true">
   /* View created to pull Monocot data from for the eMonocot project */
   /* Also see 'eMonocot' User                                        */
       SELECT  Plant_name_id,
               Date_of_entry,
               Full_epithet,
               Family,
               Genus,
               Genus_hybrid_marker,
               Species,
               Species_hybrid_marker,
               Infraspecific_rank,
               Infraspecific_epithet,
               Accepted_plant_name_id,
               Institute_id,
               Modified_date,
               NULL AS Deleted_date
       FROM  Plant_Name
UNION ALL
       SELECT  Plant_name_id,
               Date_of_entry,
               Full_epithet,
               Family,
               Genus_hybrid_marker,
               Genus,
               Species_hybrid_marker,
               Species,
               Infraspecific_rank,
               Infraspecific_epithet,
               Accepted_plant_name_id,
               Institute_id,
               Modified_date,
               Deleted_date
       FROM  Plant_Name_Deleted
        </createView>
    </changeSet>
    <changeSet author="jk00kg" id="2011-07-01">
        <addColumn tableName="Plant_Name">
            <column name="Date_Name_modified" type="datetime"/>
            <column name="Date_Locality_modified" type="datetime"/>
            <column name="Date_Authors_modified" type="datetime"/>
            <column name="Date_Citations_modified" type="datetime"/>
        </addColumn>
        <addColumn tableName="Plant_Name_Deleted">
            <column name="Date_Name_modified" type="datetime"/>
            <column name="Date_Locality_modified" type="datetime"/>
            <column name="Date_Authors_modified" type="datetime"/>
            <column name="Date_Citations_modified" type="datetime"/>
        </addColumn>
    </changeSet>
    <changeSet author="jk00kg" id="2011-07-01_1">
        <createTable tableName="Authors">
            <column name="Author_id" type="integer">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="Author" type="varchar(100)"/>
        </createTable>
    </changeSet>
    <changeSet author="ben" id="2011-07-01_1a">
        <createTable tableName="Author_Type">
            <column name="Author_type_id" type="varchar(3)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <!-- TODO Add other columns here -->
        </createTable>
    </changeSet>
    <changeSet author="jk00kg" id="2011-07-01_2">
        <createTable tableName="Plant_Author">
            <column name="Plant_author_id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="true"/>
            </column>
            <column name="Plant_name_id" type="integer">
                <constraints references="Plant_Name(Plant_name_id)" foreignKeyName="Plant_Author_Plant_Name_FK"/>
            </column>
            <column name="Author_type_id" type="varchar(3)">
                <constraints references="Author_Type(Author_type_id)" foreignKeyName="Plant_Author_Author_Type_FK"/>
            </column>
            <column name="Author_id" type="integer">
                <constraints references="Authors(Author_id)" foreignKeyName="Plant_Author_Authors_FK"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="jk00kg" id="2011-07-04">
        <createTable tableName="Publication_Type">
            <column name="Publication_type_id" type="integer">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="Type_of_publication" type="varchar(30)"/>
        </createTable>
    </changeSet>
    <changeSet author="jk00kg" id="2011-07-04_1">
        <createTable tableName="Publication">
            <column name="Publication_id" type="integer">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="Full_title" type="varchar(255)"/>
            <column name="Author" type="varchar(150)"/>
            <column name="Published" type="varchar(100)"/><!-- more commonly called publisher -->
            <column name="Publication_type_id" type="integer">
                <constraints references="Publication_Type(Publication_type_id)" foreignKeyName="Publication_Publication_type_FK"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="jk00kg" id="2011-07-04_2">
        <createTable tableName="Publication_Edition">
            <column name="Publication_edition_id" type="integer">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="Publication_id"  type="integer">
                <constraints references="Publication(Publication_id)" foreignKeyName="Publication_Edition_Publication_FK"/>
            </column>
            <column name="Article_author" type="varchar(150)"/>
            <column name="Article_title" type="varchar(255)"/>
        </createTable>
    </changeSet>
    <changeSet author="jk00kg" id="2011-07-04_3">
        <createTable tableName="Plant_Citation">
            <column name="Plant_citation_id" type="integer">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="Plant_name_id" type="integer">
                <constraints references="Plant_Name(Plant_name_id)" foreignKeyName="Plant_Citation_Plant_Name_FK"/>
            </column>
            <column name="Publication_edition_id" type="integer">
                <constraints references="Publication_Edition(Publication_edition_id)" foreignKeyName="Plant_Citation_Publication_Edition_FK"/>
            </column>
        </createTable>
    </changeSet>
    <!-- TODO: consider adding columns that aren't of interest right now -->
    <changeSet author="ben" id="2011-07-04_1">
      <sql>
      CREATE TRIGGER `Plant_name_update_trigger` BEFORE UPDATE ON `plant_name` FOR 
      EACH ROW SET NEW.Modified_date = NOW(), NEW.Date_Name_modified = NOW()
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-07-04_2">
      <sql>
      CREATE TRIGGER `Plant_name_delete_trigger` AFTER DELETE ON `plant_name` FOR 
      EACH ROW INSERT INTO plant_name_deleted (Plant_name_id, Full_epithet, Institute_id, Accepted_plant_name_id,
      Modified_date, Date_of_entry, Family, Genus_hybrid_marker, Genus, Species_hybrid_marker, Species, Infraspecific_rank,
      Infraspecific_epithet, Date_Name_modified, Date_Locality_modified, Date_Authors_modified, Date_Citations_modified,
      Deleted_date) VALUES (OLD.Plant_name_id, OLD.Full_epithet, OLD.Institute_id, OLD.Accepted_plant_name_id,
      OLD.Modified_date, OLD.Date_of_entry, OLD.Family, OLD.Genus_hybrid_marker, OLD.Genus, OLD.Species_hybrid_marker, OLD.Species, 
      OLD.Infraspecific_rank, OLD.Infraspecific_epithet, OLD.Date_Name_modified, OLD.Date_Locality_modified, OLD.Date_Authors_modified,
      OLD.Date_Citations_modified, NOW())
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-07-04_3">
      <sql>
      CREATE TRIGGER `Plant_locality_insert_trigger` AFTER INSERT ON `plant_locality` FOR 
      EACH ROW UPDATE plant_name SET Modified_date = NOW(), Date_Locality_modified = NOW()
      WHERE Plant_name_id = NEW.Plant_name_id
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-07-04_4">
      <sql>
      CREATE TRIGGER `Plant_locality_update_trigger` AFTER UPDATE ON `plant_locality` FOR 
      EACH ROW UPDATE plant_name SET Modified_date = NOW(), Date_Locality_modified = NOW()
      WHERE Plant_name_id = NEW.Plant_name_id
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-07-04_5">
      <sql>
      CREATE TRIGGER `Plant_locality_delete_trigger` AFTER DELETE ON `plant_locality` FOR 
      EACH ROW UPDATE plant_name SET Modified_date = NOW(), Date_Locality_modified = NOW()
      WHERE Plant_name_id = OLD.Plant_name_id
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-07-04_6">
      <addAutoIncrement tableName="Plant_name" columnName="Plant_name_id" columnDataType="integer"/>
    </changeSet>
    <changeSet author="ben" id="2011-07-06_1">
      <sql>
      CREATE TRIGGER `Plant_author_insert_trigger` AFTER INSERT ON `plant_author` FOR 
      EACH ROW UPDATE plant_name SET Modified_date = NOW(), Date_Authors_modified = NOW()
      WHERE Plant_name_id = NEW.Plant_name_id
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-07-06_2">
      <sql>
      CREATE TRIGGER `Plant_author_update_trigger` AFTER UPDATE ON `plant_author` FOR 
      EACH ROW UPDATE plant_name SET Modified_date = NOW(), Date_Authors_modified = NOW()
      WHERE Plant_name_id = NEW.Plant_name_id
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-07-06_3">
      <sql>
      CREATE TRIGGER `Plant_author_delete_trigger` AFTER DELETE ON `plant_author` FOR 
      EACH ROW UPDATE plant_name SET Modified_date = NOW(), Date_Authors_modified = NOW()
      WHERE Plant_name_id = OLD.Plant_name_id
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-07-06_4">
      <sql>
      CREATE TRIGGER `Plant_citation_insert_trigger` AFTER INSERT ON `plant_citation` FOR 
      EACH ROW UPDATE plant_name SET Modified_date = NOW(), Date_Citations_modified = NOW()
      WHERE Plant_name_id = NEW.Plant_name_id
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-07-06_5">
      <sql>
      CREATE TRIGGER `Plant_citation_update_trigger` AFTER UPDATE ON `plant_citation` FOR 
      EACH ROW UPDATE plant_name SET Modified_date = NOW(), Date_Citations_modified = NOW()
      WHERE Plant_name_id = NEW.Plant_name_id
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-07-06_6">
      <sql>
      CREATE TRIGGER `Plant_citation_delete_trigger` AFTER DELETE ON `plant_citation` FOR 
      EACH ROW UPDATE plant_name SET Modified_date = NOW(), Date_Citations_modified = NOW()
      WHERE Plant_name_id = OLD.Plant_name_id
      </sql>
    </changeSet>
    <changeSet author="ben" id="2011-07-06_7">
      <addAutoIncrement tableName="Plant_locality" columnName="Plant_locality_id" columnDataType="integer"/>
    </changeSet>
    <changeSet author="ben" id="2011-07-06_8">
      <modifyDataType tableName="Plant_locality" columnName="Area_code_L3" newDataType="varchar(3)"/>      
    </changeSet>
    <changeSet author="ben" id="2011-07-06_9">
      <addAutoIncrement tableName="Plant_author" columnName="Plant_author_id" columnDataType="integer"/>
    </changeSet>
    <changeSet author="ben" id="2011-07-06_10">
      <addAutoIncrement tableName="Plant_citation" columnName="Plant_citation_id" columnDataType="integer"/>
    </changeSet>
    <changeSet author="ben" id="2011-07-20_5">
        <addColumn tableName="Plant_Name">
            <column name="Publication_author" type="varchar(60)"/>
        </addColumn>
        <addColumn tableName="Plant_Name">
            <column name="Volume_and_page" type="varchar(30)"/>
        </addColumn>
        <addColumn tableName="Plant_Name">
            <column name="First_published" type="varchar(22)"/>
        </addColumn>
        <addColumn tableName="Plant_Name">
            <column name="Place_of_publication_id" type="integer"/>
        </addColumn>
    </changeSet>
    <changeSet author="ben" id="2011-07-20_6">
        <createTable tableName="Place_of_publication">
            <column name="Place_of_publication_id" type="integer">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="Place_of_publication" type="varchar(255)"/>
        </createTable>
    </changeSet>
    <changeSet author="ben" id="2011-07-20_7">
        <addForeignKeyConstraint constraintName="FKC663751FC1A8E6DC"
            baseTableName="Plant_Name" baseColumnNames="Place_of_publication_id" referencedTableName="Place_of_publication"
            referencedColumnNames="Place_of_publication_id"/>
    </changeSet>
    <changeSet author="ben" id="2011-07-20_8">
        <addColumn tableName="Plant_Name_Deleted">
            <column name="Publication_author" type="varchar(60)"/>
        </addColumn>
        <addColumn tableName="Plant_Name_Deleted">
            <column name="Volume_and_page" type="varchar(30)"/>
        </addColumn>
        <addColumn tableName="Plant_Name_Deleted">
            <column name="First_published" type="varchar(22)"/>
        </addColumn>
        <addColumn tableName="Plant_Name_Deleted">
            <column name="Place_of_publication_id" type="integer"/>
        </addColumn>
    </changeSet>
    <changeSet author="ben" id="2011-07-20_9">
        <!-- replaceIfExists attribute needs to be removed if using Sybase -->
        <createView viewName="vwMonocot_Name" replaceIfExists="true">
   /* View created to pull Monocot data from for the eMonocot project */
   /* Also see 'eMonocot' User                                        */
       SELECT  Plant_name_id,
               Date_of_entry,
               Full_epithet,
               Family,
               Genus,
               Genus_hybrid_marker,
               Species,
               Species_hybrid_marker,
               Infraspecific_rank,
               Infraspecific_epithet,
               Accepted_plant_name_id,
               Institute_id,
               Modified_date,
               NULL AS Deleted_date,
               Publication_author,
               Volume_and_page,
               First_published,
               Place_of_publication_id
       FROM  Plant_Name
UNION ALL
       SELECT  Plant_name_id,
               Date_of_entry,
               Full_epithet,
               Family,
               Genus_hybrid_marker,
               Genus,
               Species_hybrid_marker,
               Species,
               Infraspecific_rank,
               Infraspecific_epithet,
               Accepted_plant_name_id,
               Institute_id,
               Modified_date,
               Deleted_date,
               Publication_author,
               Volume_and_page,
               First_published,
               Place_of_publication_id
       FROM  Plant_Name_Deleted
        </createView>
    </changeSet>
</databaseChangeLog>
